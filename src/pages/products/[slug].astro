---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { PRODUCTS, getProductBySlug } from '@/data/products';
import { withBase } from '@/site';
import ProductGallery from '@/components/sections/ProductGallery';
import ProductCard from '@/components/sections/ProductCard';
import { deriveProductSpecs } from '@/utils/productSpecs';

export function getStaticPaths() {
  return PRODUCTS.map((product) => ({
    params: { slug: product.slug },
  }));
}

const { slug } = Astro.params;
const product = getProductBySlug(slug);

if (!product) {
  return Astro.redirect(withBase('/products/'));
}

const shortLead =
  product.description.length > 220
    ? `${product.description.slice(0, 220).trimEnd()}…`
    : product.description;

const highlights = product.features.filter((f) => f?.trim()).slice(0, 4);
const productSpecs = deriveProductSpecs(product, 12);
const fallbackHighlights = [
  'Надёжная конструкция промышленного уровня',
  'Электромеханический привод с амортизацией',
  'Подходит для интенсивной эксплуатации',
  'Интеграция в существующие стрелковые комплексы',
];

const related = PRODUCTS
  .filter((p) => p.slug !== product.slug)
  .sort((a, b) => {
    const aSame = a.categoryId === product.categoryId ? 1 : 0;
    const bSame = b.categoryId === product.categoryId ? 1 : 0;
    return bSame - aSame || a.name.localeCompare(b.name, 'ru');
  })
  .slice(0, 4);
---

<BaseLayout
  title={product.name}
  description={product.description.slice(0, 160)}
>
  <main class="xtir-section min-h-screen">
    <div class="xtir-container">
      <div class="grid gap-8 lg:grid-cols-12 lg:gap-10">
        <div class="lg:col-span-7">
          {product.photos.length > 0 ? (
            <ProductGallery client:visible images={product.photos} alt={product.name} />
          ) : (
            <div class="xtir-card flex aspect-[16/10] w-full items-center justify-center text-white/50">
              Фото скоро появятся
            </div>
          )}
        </div>

        <aside class="space-y-5 lg:col-span-5">
          <div class="xtir-card p-5 md:p-6">
            <p class="kicker mb-2">{product.category}</p>
            <h1 class="xtir-title">{product.name}</h1>
            <p class="xtir-lead mt-3">{shortLead}</p>

            <div class="mt-5 grid gap-2">
              {(highlights.length > 0 ? highlights : fallbackHighlights).map((item) => (
                <div class="flex items-start gap-2 text-sm leading-6 text-white/82">
                  <span class="mt-1 inline-block h-1.5 w-1.5 shrink-0 rounded-full bg-primary-400"></span>
                  <span>{item}</span>
                </div>
              ))}
            </div>

            <div class="mt-6 flex flex-wrap gap-3">
              <a href={withBase('/contact/')} class="xtir-btn xtir-btn--primary">
                Оставить заявку
              </a>
              <a href={withBase('/products/')} class="xtir-btn xtir-btn--secondary">
                Вернуться в каталог
              </a>
            </div>
          </div>

          <section class="xtir-card p-5 md:p-6">
            <h2 class="text-xl font-semibold text-white">Технические характеристики</h2>

            {productSpecs.length > 0 ? (
              <dl class="mt-4 divide-y divide-white/10">
                {productSpecs.map((spec) => (
                  <div class="grid gap-2 py-3 text-sm sm:grid-cols-[minmax(0,1fr)_minmax(0,1.2fr)] sm:items-center">
                    <dt class="text-white/62">{spec.label}</dt>
                    <dd class="text-left font-medium text-white/92 sm:text-right">{spec.value}</dd>
                  </div>
                ))}
              </dl>
            ) : (
              <p class="xtir-lead mt-3">Технические характеристики уточняются для этой модели.</p>
            )}
          </section>
        </aside>
      </div>

      <section class="xtir-section pt-12 cv-auto">
        <div class="xtir-card p-6 md:p-8">
          <h2 class="text-2xl font-semibold text-white">Описание</h2>
          <p class="mt-4 max-w-[74ch] text-base leading-7 text-white/82">{product.description}</p>
        </div>
      </section>

      {related.length > 0 && (
        <section class="xtir-section pt-6 cv-auto">
          <div class="mb-6 flex flex-wrap items-end justify-between gap-4">
            <h2 class="text-2xl font-semibold text-white">Похожие решения</h2>
            <a href={withBase('/products/')} class="xtir-btn xtir-btn--secondary text-sm">
              Весь каталог
            </a>
          </div>

          <div class="grid auto-rows-fr grid-cols-1 gap-5 md:grid-cols-2 xl:grid-cols-4">
            {related.map((item) => (
              <ProductCard product={item} categoryName={item.category} />
            ))}
          </div>
        </section>
      )}
    </div>
  </main>
</BaseLayout>
