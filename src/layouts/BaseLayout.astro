---
import { SITE } from '@/site';
import '@/styles/global.css';

type Props = {
  title?: string;
  description?: string;
  image?: string;
  noindex?: boolean;
};

const { title, description, image, noindex } = Astro.props;

const pageTitle = title ? `${title} — ${SITE.name}` : SITE.name;
const pageDescription = description ?? SITE.description ?? '';
const canonical = Astro.url?.toString();

function absUrl(path: string) {
  // Astro.site берётся из astro.config.mjs (site), поэтому абсолютные OG-ссылки будут стабильны.
  const base = Astro.site ? Astro.site.toString() : SITE.url ?? '';
  try {
    return new URL(path, base).toString();
  } catch {
    return path;
  }
}

const ogImage = image ? absUrl(image) : (SITE.ogImage ? absUrl(SITE.ogImage) : undefined);
---

<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{pageTitle}</title>
    {pageDescription && <meta name="description" content={pageDescription} />}

    {canonical && <link rel="canonical" href={canonical} />}

    {noindex ? <meta name="robots" content="noindex,nofollow" /> : null}

    <meta property="og:title" content={pageTitle} />
    {pageDescription && <meta property="og:description" content={pageDescription} />}
    {canonical && <meta property="og:url" content={canonical} />}
    <meta property="og:type" content="website" />
    {ogImage && <meta property="og:image" content={ogImage} />}

    <meta name="theme-color" content="#0b1220" />
  </head>

  <body class="min-h-screen bg-dark-950 text-white">
    <slot />

    <script is:inline>
      // 1) Кнопки "Запросить" (вместо любых "Скачать") ведём на /contact с параметрами
      document.addEventListener('click', (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;

        const btn = t.closest('[data-xtir-request]');
        if (!btn) return;

        e.preventDefault();

        const product = btn.getAttribute('data-product') || '';
        const doc = btn.getAttribute('data-doc') || '';
        const href = `/contact?from=docs&product=${encodeURIComponent(product)}&doc=${encodeURIComponent(doc)}`;
        window.location.href = href;
      });

      // 2) Копирование ссылки (если где-то есть data-copy-link)
      document.addEventListener('click', async (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;

        const btn = t.closest('[data-copy-link]');
        if (!btn) return;

        e.preventDefault();
        const url = btn.getAttribute('data-copy-link') || '';
        if (!url) return;

        try {
          await navigator.clipboard.writeText(url);
          btn.setAttribute('data-copied', '1');
          setTimeout(() => btn.removeAttribute('data-copied'), 900);
        } catch {}
      });
    </script>
  </body>
</html>
