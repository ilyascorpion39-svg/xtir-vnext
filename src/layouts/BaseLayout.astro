---
import '@/styles/global.css';

interface Props {
  title: string;
  description?: string;
  image?: string;
}

const { 
  title, 
  description = 'XTIR - Разработка и производство электронно-механического оборудования для стрельбы',
  image = '/images/og-image.svg'
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!doctype html>
<html lang="ru" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- SEO -->
    <title>{title} | XTIR</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, Astro.site)} />
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, Astro.site)} />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
    
    <!-- Дополнительные мета-теги -->
    <meta name="theme-color" content="#1a1a1a" />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="XTIR" />
    
    <!-- Структурированные данные -->
    <script is:inline type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "XTIR",
        "url": "https://xtir.ru",
        "logo": "https://xtir.ru/images/logo.png",
        "description": "Разработка и производство электронно-механического оборудования для стрельбы",
        "address": {
          "@type": "PostalAddress",
          "addressCountry": "RU"
        },
        "contactPoint": {
          "@type": "ContactPoint",
          "telephone": "+7-915-425-0095",
          "contactType": "customer service",
          "email": "info@xtir.ru"
        }
      }
    </script>
  </head>
  
  <body class="antialiased">
    <slot />

    <!-- XTIR Request Modal (копирование письма без открытия почтового клиента) -->
    <div id="xtir-request-modal" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/70 p-4 backdrop-blur-sm">
      <div data-panel class="w-full max-w-lg rounded-2xl border border-white/10 bg-[#121212] shadow-2xl">
        <div class="flex items-start justify-between gap-4 border-b border-white/10 p-5">
          <div>
            <h3 class="text-lg font-semibold text-white">Запрос материалов</h3>
            <p class="mt-1 text-sm text-white/70">Скопируйте готовое письмо и отправьте его на почту XTIR.</p>
          </div>
          <button type="button" data-close class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white/80 hover:bg-white/10">Закрыть</button>
        </div>

        <div class="space-y-4 p-5">
          <div class="rounded-xl border border-white/10 bg-white/[0.03] p-4">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div class="text-sm text-white/70">Email для запроса</div>
              <div class="flex items-center gap-2">
                <code data-email class="rounded-lg bg-black/30 px-2 py-1 text-sm text-[#8DFF3A]">info@xtir.ru</code>
                <button type="button" data-copy-email class="rounded-lg border border-[#8DFF3A]/40 bg-[#8DFF3A]/10 px-3 py-1.5 text-sm font-medium text-[#8DFF3A] hover:bg-[#8DFF3A]/15">Скопировать</button>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div class="rounded-xl border border-white/10 bg-white/[0.03] p-4">
              <div class="text-xs uppercase tracking-wide text-white/50">Изделие</div>
              <div data-product class="mt-1 text-sm font-medium text-white">—</div>
            </div>
            <div class="rounded-xl border border-white/10 bg-white/[0.03] p-4">
              <div class="text-xs uppercase tracking-wide text-white/50">Материал</div>
              <div data-doc class="mt-1 text-sm font-medium text-white">—</div>
            </div>
          </div>

          <div>
            <div class="flex items-center justify-between gap-3">
              <div class="text-sm text-white/80">Тема письма</div>
              <button type="button" data-copy-subject class="text-sm text-white/70 hover:text-white">Скопировать тему</button>
            </div>
            <div data-subject class="mt-2 rounded-xl border border-white/10 bg-white/[0.03] px-4 py-3 text-sm text-white">XTIR: запрос документации</div>
          </div>

          <div>
            <div class="flex items-center justify-between gap-3">
              <div class="text-sm text-white/80">Текст письма</div>
              <button type="button" data-copy-body class="text-sm text-white/70 hover:text-white">Скопировать текст</button>
            </div>
            <textarea data-body rows="8" class="mt-2 w-full resize-none rounded-xl border border-white/10 bg-white/[0.03] p-4 text-sm text-white outline-none placeholder:text-white/40 focus:border-[#8DFF3A]/50" placeholder="Текст запроса…"></textarea>
          </div>

          <div class="flex flex-col gap-3 sm:flex-row">
            <button type="button" data-copy-letter class="w-full rounded-xl bg-[#8DFF3A] px-4 py-3 text-sm font-semibold text-black hover:brightness-105">Скопировать письмо целиком</button>
            <a href="/contact" class="w-full rounded-xl border border-[#8DFF3A]/50 bg-[#8DFF3A]/10 px-4 py-3 text-center text-sm font-semibold text-[#8DFF3A] hover:bg-[#8DFF3A]/15">Перейти в контакты</a>
          </div>

          <div data-toast class="hidden rounded-xl border border-[#8DFF3A]/30 bg-[#8DFF3A]/10 px-4 py-3 text-sm text-[#8DFF3A]">Скопировано ✅</div>
        </div>
      </div>
    </div>

    <script is:inline>
      (function () {
        const modal = document.getElementById('xtir-request-modal');
        if (!modal) return;

        const panel = modal.querySelector('[data-panel]');
        const toast = modal.querySelector('[data-toast]');
        const emailEl = modal.querySelector('[data-email]');
        const productEl = modal.querySelector('[data-product]');
        const docEl = modal.querySelector('[data-doc]');
        const subjectEl = modal.querySelector('[data-subject]');
        const bodyEl = modal.querySelector('[data-body]');

        const copyEmailBtn = modal.querySelector('[data-copy-email]');
        const copySubjectBtn = modal.querySelector('[data-copy-subject]');
        const copyBodyBtn = modal.querySelector('[data-copy-body]');
        const copyLetterBtn = modal.querySelector('[data-copy-letter]');

        const closeBtns = modal.querySelectorAll('[data-close]');

        let payload = {
          email: 'info@xtir.ru',
          product: '—',
          doc: '—',
          subject: 'XTIR: запрос документации',
          body: '',
        };

        function showToast() {
          if (!toast) return;
          toast.classList.remove('hidden');
          clearTimeout(showToast._t);
          showToast._t = setTimeout(() => toast.classList.add('hidden'), 1600);
        }

        async function copyToClipboard(text) {
          try {
            await navigator.clipboard.writeText(text);
            showToast();
          } catch (e) {
            // fallback
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            window.prompt('Скопируйте текст:', text);
            document.body.removeChild(ta);
            showToast();
          }
        }

        function openModal(p) {
          payload = { ...payload, ...p };
          if (emailEl) emailEl.textContent = payload.email;
          if (productEl) productEl.textContent = payload.product || '—';
          if (docEl) docEl.textContent = payload.doc || '—';
          if (subjectEl) subjectEl.textContent = payload.subject || 'XTIR: запрос документации';
          if (bodyEl) bodyEl.value = payload.body || '';

          modal.classList.remove('hidden');
          modal.classList.add('flex');
          document.documentElement.classList.add('overflow-hidden');
        }

        function closeModal() {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.documentElement.classList.remove('overflow-hidden');
        }

        closeBtns.forEach((b) => b.addEventListener('click', closeModal));
        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
        });

        document.addEventListener('click', (e) => {
          const trg = e.target && (e.target.closest ? e.target.closest('[data-xtir-request]') : null);
          if (!trg) return;
          e.preventDefault();

          const product = trg.getAttribute('data-product') || '';
          const doc = trg.getAttribute('data-doc') || '';

          const subject = `XTIR: запрос — ${doc || 'документация'} (${product || 'изделие'})`;
          const body = [
            'Здравствуйте!',
            '',
            'Прошу предоставить материал:',
            `— ${doc || 'Документация'}`,
            product ? `Изделие: ${product}` : '',
            '',
            'Цель запроса: ',
            'Контакты для ответа: ',
            '',
            'Спасибо!',
          ].filter(Boolean).join('\n');

          openModal({
            email: 'info@xtir.ru',
            product: product || '—',
            doc: doc || '—',
            subject,
            body,
          });
        });

        if (copyEmailBtn) copyEmailBtn.addEventListener('click', () => copyToClipboard(payload.email));
        if (copySubjectBtn) copySubjectBtn.addEventListener('click', () => copyToClipboard(payload.subject));
        if (copyBodyBtn) copyBodyBtn.addEventListener('click', () => copyToClipboard(bodyEl ? bodyEl.value : payload.body));
        if (copyLetterBtn) copyLetterBtn.addEventListener('click', () => {
          const body = bodyEl ? bodyEl.value : payload.body;
          const full = `Кому: ${payload.email}
Тема: ${payload.subject}

${body}`;
          copyToClipboard(full);
        });
      })();
    </script>

    
    <!-- Analytics (опционально) -->
    <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script> -->
  </body>
</html>

<style is:global>
  @supports (scrollbar-color: auto) {
    * {
      scrollbar-width: thin;
      scrollbar-color: #00ff41 #1a1a1a;
    }
  }
</style>













